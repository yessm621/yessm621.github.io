---
layout: post
title: "JPA N+1 ë¬¸ì œ"
date: 2023-01-31 11:30:00
categories: [JPA]
tags:
  - JPA
author: "ìœ ì"
---

JPAë¥¼ ì‚¬ìš©í•˜ë‹¤ ë³´ë©´ ì˜ë„í•˜ì§€ ì•Šì•˜ì§€ë§Œ select ì¿¼ë¦¬ê°€ ì—¬ëŸ¬ ê°œ ë°œìƒí•˜ëŠ” í˜„ìƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ì´ëŸ¬í•œ í˜„ìƒì„ `N+1 ë¬¸ì œ`ë¼ê³  ë¶€ë¥´ëŠ”ë° ì´ ë¬¸ì œê°€ ì™œ ë°œìƒí•˜ëŠ”ì§€ì™€ ì´ì— ëŒ€í•œ í•´ê²° ë°©ë²•ì„ ì•Œì•„ë³´ì.

## **N+1 ë¬¸ì œë€?**

ê°„ë‹¨íˆ ë§í•˜ìë©´, ì¡°íšŒ ì‹œ **1ê°œì˜ ì¿¼ë¦¬**ë¥¼ ìƒê°í•˜ê³  ì„¤ê³„ë¥¼ í–ˆìœ¼ë‚˜ ë‚˜ì˜¤ì§€ ì•Šì•„ë„ ë˜ëŠ” ì¡°íšŒì˜ ì¿¼ë¦¬ê°€ `Nê°œ` ë” ë°œìƒí•˜ëŠ” ë¬¸ì œì´ë‹¤. 

ì´ ë¬¸ì œëŠ” **ì—°ê´€ê´€ê³„ê°€ ìˆëŠ” ì—”í‹°í‹°ê°„ì— ë°œìƒ**í•œë‹¤. ì—°ê´€ ê´€ê³„ê°€ ì„¤ì •ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ê²½ìš°ì— ì¡°íšŒëœ ë°ì´í„° ê°¯ìˆ˜(N) ë§Œí¼ ì—°ê´€ê´€ê³„ì˜ ì¡°íšŒ ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•˜ëŠ” í˜„ìƒì´ë‹¤.

## N+1 ì˜ˆì œ

ë‹¤ìŒì€ N+1 ë¬¸ì œë¥¼ ì„¤ëª…í•˜ê¸° ìœ„í•œ ì˜ˆì œì´ë‹¤.

- Team ì—”í‹°í‹°, User ì—”í‹°í‹°
- Teamê³¼ UserëŠ” ì–‘ë°©í–¥ ì¼ëŒ€ë‹¤ ì—°ê´€ê´€ê³„

```java
@Entity
@Getter @Setter
public class Team {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "team_id")
    private Long id;
    private String name;

    @OneToMany(mappedBy = "team")
    private List<User> users = new ArrayList<>();
}
```

```java
@Entity
@Getter @Setter
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "user_id")
    private Long id;
    private String username;

    @ManyToOne
    @JoinColumn(name = "team_id")
    private Team team;
}
```

> **ì°¸ê³ **
FetchTypeì€ Defaultë¡œ *ToMany ì—ì„œëŠ” Lazy Loading, *ToOne ì—ì„œëŠ” Eager Loadingë¡œ ì§€ì •ëœë‹¤. default ì˜µì…˜ì„ ì‚¬ìš©í•´ë„ ëª…ì‹œí•´ì£¼ëŠ” ê²ƒì´ í˜‘ì—…í•˜ëŠ” ë‹¤ë¥¸ ê°œë°œìê°€ ë³´ê¸°ì— ì¢‹ë‹¤.
> 

í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ 2ê°œì˜ íŒ€ì„ ë§Œë“¤ê³  ê° íŒ€ì— 2ëª…ì˜ ì‚¬ìš©ìë¥¼ ë„£ê² ë‹¤.

```java
public class JpaProblem {

    public static void main(String[] args) {

        EntityManagerFactory emf = Persistence.createEntityManagerFactory("hello");
        EntityManager em = emf.createEntityManager();
        EntityTransaction tx = em.getTransaction();
        tx.begin();

        try {
            Team team = null;
            for (int i = 0; i < 2; i++) {
                team = new Team();
                team.setName("team" + i);
                em.persist(team);
            }

            for (int j = 0; j < 2; j++) {
                User user = new User();
                user.setUsername("member" + j);
                user.setTeam(team);
                em.persist(user);
            }
            em.flush();
            em.clear();

            List<User> users = em.createQuery("select u from User u", User.class)
                    .getResultList();
            tx.commit();
        } catch (Exception e) {
            tx.rollback();
            e.printStackTrace();
        } finally {
            em.close();
        }
        emf.close();
    }
}
```

### Fetch ëª¨ë“œê°€ EAGERì¸ ê²½ìš°

```java
public class User {
    ...

    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "team_id")
    private Team team;
}
```

```
Hibernate: /* select u from User u */ select 
user0_.user_id as user_id1_1_, user0_.team_id as team_id3_1_, user0_.username as username2_1_ from User user0_
Hibernate: select team0_.team_id as team_id1_0_0_, team0_.name as name2_0_0_ from Team team0_ where team0_.team_id=?
Hibernate: select team0_.team_id as team_id1_0_0_, team0_.name as name2_0_0_ from Team team0_ where team0_.team_id=?
```

- userë¥¼ ì¡°íšŒí•˜ëŠ” selectë¬¸ì´ ë°œìƒí•œë‹¤.
- userë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ê°€ teamì„ ì¡°íšŒí•œ row ë§Œí¼ selectë¬¸ì„ í˜¸ì¶œí•œë‹¤.

FetchType.EAGERì—ì„œ N+1 ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤.

### N+1 ë¬¸ì œëŠ” ì¦‰ì‹œë¡œë”©ì—ì„œ ë°œìƒ?

NO! **N+1 ë¬¸ì œëŠ” FetchTypeìœ¼ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ë¬¸ì œê°€ ì•„ë‹ˆë‹¤.** ì§€ì—°ë¡œë”©ìœ¼ë¡œ ë³€ê²½í•´ë„ N+1 ë¬¸ì œëŠ” ë°œìƒí•œë‹¤. 

### Fetch ëª¨ë“œê°€ Lazyì¸ ê²½ìš°

```java
public class User {
    ...

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "team_id")
    private Team team;
}
```

```
Hibernate: /* select u from User u */ select user0_.user_id as user_id1_1_, user0_.team_id as team_id3_1_, user0_.username as username2_1_ from User user0_
```

- userë¥¼ ì¡°íšŒí•˜ëŠ” selectë¬¸ì´ ë°œìƒí•œë‹¤.

ì¿¼ë¦¬ë¬¸ì´ í•˜ë‚˜ë§Œ í˜¸ì¶œë˜ì—ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ N+1 ë¬¸ì œê°€ í•´ê²°ëœ ê²ƒì¼ê¹Œ? ì•„ì‰½ê²Œë„ í•´ê²°ëœ ê²ƒì´ ì•„ë‹ˆë‹¤.ğŸ¥²  ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì„¤ì •í–ˆë‹¤ëŠ” ê²ƒì€ ì—°ê´€ê´€ê³„ ë°ì´í„°ë¥¼ í”„ë¡ì‹œ ê°ì²´ë¡œ ë°”ì¸ë”©í•œ ê²ƒì´ë‹¤. ì‹¤ì œ ì—°ê´€ê´€ê³„ì˜ ì—”í‹°í‹°ë¥¼ í˜¸ì¶œ ì‹œ teamì— ëŒ€í•œ ì¿¼ë¦¬ë¬¸ì´ ë°œìƒí•œë‹¤.

ê²°êµ­, **ì¦‰ì‹œë¡œë”©ê³¼ ì§€ì—°ë¡œë”©ì€ ë™ì¼í•œ ê²°ê³¼ê°€ ë°œìƒ**í•œë‹¤. FetchTypeì„ ë³€ê²½í•˜ëŠ” ê²ƒì€ ë‹¨ì§€ N+1 ë°œìƒ ì‹œì ì„ ì—°ê´€ê´€ê³„ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ì‹œì ìœ¼ë¡œ ë¯¸ë£°ì§€, ì•„ë‹ˆë©´ ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹œì ì— ê°€ì ¸ì˜¬ì§€ì˜ ì°¨ì´ì´ë‹¤.

ê·¸ë ‡ë‹¤ë©´, N+1ì€ ì™œ ë°œìƒí•˜ëŠ” ê²ƒì¼ê¹Œ?

## ë°œìƒ ì›ì¸

**N+1 ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ì´ìœ **ëŠ” `JPQL`ì—ì„œ ì°¾ì„ ìˆ˜ ìˆë‹¤. JPQLì€ SQLì„ ì¶”ìƒí™”í•œ ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´ë¡œì„œ íŠ¹ì • SQLì— ì¢…ì†ë˜ì§€ ì•Šê³  ì—”í‹°í‹° ê°ì²´ì™€ í•„ë“œ ì´ë¦„ì„ ê°€ì§€ê³  ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•œë‹¤. ë”°ë¼ì„œ, ìœ„ì˜ User ì—”í‹°í‹°ì™€ Team ì—”í‹°í‹°ê°€ ì—°ê´€ê´€ê³„ê°€ ìˆìŒì—ë„ JPQL ì…ì¥ì—ì„  ì—°ê´€ê´€ê³„ ë°ì´í„°ë¥¼ ë¬´ì‹œí•˜ê³  **í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ì¡°íšŒ**í•œë‹¤. (select * from User) ê·¸ë ‡ê¸° ë•Œë¬¸ì— **ì—°ê´€ëœ ì—”í‹°í‹° ë°ì´í„°ê°€ í•„ìš”í•œ ê²½ìš°**, FetchTypeìœ¼ë¡œ ì§€ì •í•œ ì‹œì ì— **ë³„ë„ë¡œ ì¡°íšŒ**í•˜ê²Œ ëœë‹¤.

## **í•´ê²° ë°©ì•ˆ**

í•´ê²°ë°©ì•ˆìœ¼ë¡  ë‹¤ìŒê³¼ ê°™ì€ ë°©ë²•ì´ ìˆë‹¤. í•˜ë‚˜ì”© ì‚´í´ë³´ì.

- JPQL Fetch Join ì‚¬ìš©
- EntityGraph ì• ë…¸í…Œì´ì…˜
- Batch Size

### JPQL Fetch Join ì‚¬ìš©

ìš°ë¦¬ê°€ ì›í•˜ëŠ” ì½”ë“œëŠ” â€˜select * from Team left join User on User.team_id = Team.idâ€™ ì´ë‹¤. JPQLì˜ `fetch join`ì„ ì‚¬ìš©í•˜ë©´ ìš°ë¦¬ê°€ ì›í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤.

```java
List<Team> teams = em.createQuery("select t from Team t left join fetch t.users", Team.class)
                    .getResultList();
```

```
Hibernate: /* select t from Team t left join fetch t.users */ select team0_.team_id as team_id1_0_0_, users1_.user_id as user_id1_1_1_, team0_.name as name2_0_0_, users1_.team_id as team_id3_1_1_, users1_.username as username2_1_1_, users1_.team_id as team_id3_1_0__, users1_.user_id as user_id1_1_0__ from Team team0_ left outer join User users1_ on team0_.team_id=users1_.team_id
```

ë¡œê·¸ë¥¼ ì‚´í´ë³´ë©´ ì›í•˜ëŠ” ëŒ€ë¡œ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ë¬¸ í•œ ê°œê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

í•˜ì§€ë§Œ, fetch joinë„ ë‹¨ì ì´ ìˆë‹¤. ìš°ì„  ìš°ë¦¬ê°€ ì—°ê´€ê´€ê³„ë¡œ ì„¤ì •í•´ë†“ì€ FetchTypeì„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì´ë‹¤. fetch joinì„ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ë°ì´í„° í˜¸ì¶œ ì‹œì ì— ëª¨ë“  ì—°ê´€ê´€ê³„ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì— FetchTypeì„ Lazyë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ë¬´ì˜ë¯¸í•˜ë‹¤.

ë˜í•œ, **í˜ì´ì§• ì¿¼ë¦¬**ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤ëŠ” ì ê³¼ **2ê°œ ì´ìƒì˜ Collection join**ì´ ì•ˆëœë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤.

### @EntityGraph ì• ë…¸í…Œì´ì…˜

JPQLì—ì„œ fetch joinì„ í•˜ê²Œ ë˜ë©´ í•˜ë“œì½”ë”© í•˜ê²Œ ëœë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤. ì´ë¥¼ ìµœì†Œí™” í•˜ê³  ì‹¶ì„ ë•Œ `@EntityGraph`ë¥¼ ì‚¬ìš©í•œë‹¤. ê·¸ëƒ¥ ì´ëŸ°ê²Œ ìˆêµ¬ë‚˜ë§Œ ì•Œì•„ë‘ê³  ì‚¬ìš©í•˜ì§€ ë§ì. (ë„ˆë¬´ ë³µì¡í•˜ë‹¤.)

```java
@EntityGraph(attributePaths = {"articles"}, type = EntityGraphType.FETCH)
@Query("select distinct u from User u left join u.articles")
List<User> findAllEntityGraph();
```

> **ì°¸ê³ ** Fetch Joinê³¼ EntityGraph ì£¼ì˜í•  ì 
> 
> 
> Fetch Joinê³¼ EntityGraphëŠ” JPQLì„ ì‚¬ìš©í•˜ì—¬ JOINë¬¸ì„ í˜¸ì¶œí•œë‹¤ëŠ” ê³µí†µì ì´ ìˆë‹¤. ë˜í•œ, ê³µí†µì ìœ¼ë¡œ ì¹´í…Œì‹œì•ˆ ê³±(Cartesian Product)ì´ ë°œìƒí•˜ì—¬ ì¤‘ë³µ ë°ì´í„°ê°€ ì¡´ì¬í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì¤‘ë³µëœ ë°ì´í„°ê°€ ì»¬ë ‰ì…˜ì— ì¡´ì¬í•˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ì•¼ í•œë‹¤.
> 
> **ì¤‘ë³µëœ ë°ì´í„°ë¥¼ ì œê±°**í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
> 
> - ì»¬ë ‰ì…˜ì„ Setì„ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ì¤‘ë³µì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ” ìë£Œêµ¬ì¡°ì´ê¸° ë•Œë¬¸ì— ì¤‘ë³µëœ ë°ì´í„°ë¥¼ ì œê±°í•  ìˆ˜ ìˆë‹¤.
> - JPQLì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— distinctë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µëœ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤.

### Batch Size

ì´ ì˜µì…˜ì€ ì •í™•íˆëŠ” N+1 ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸°ë³´ë‹¨ N+1 ë¬¸ì œê°€ ë°œìƒí•´ë„ `IN ë°©ì‹`ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ë°©ë²•ì´ë‹¤. ì´ë ‡ê²Œ í•˜ë©´ 100ë²ˆ ì¼ì–´ë‚  N+1 ë¬¸ì œë¥¼ 1ë²ˆë§Œ ë” ì¡°íšŒí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì„±ëŠ¥ì„ ìµœì í™”í•  ìˆ˜ ìˆë‹¤.

```sql
select * from user where team_id = ?
select * from user where team_id = ?

# Batch Size ì‚¬ìš© ì‹œ
select * from user where team_id in (?,?);
```

Batch Sizeì— ê´€ë ¨ëœ ì˜µì…˜ì€ **application.ymlì—ì„œ ì„¤ì •**í•˜ë©´ ëœë‹¤. ì„¤ì • í•˜ë‚˜ë§Œ ì„¸íŒ…í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ in ì ˆë¡œ ì¿¼ë¦¬ê°€ ë‚˜ê°„ë‹¤.

```yaml
spring:
  jpa:
    properties:
      hibernate:
        default_batch_fetch_size: 1000
```

Batch SizeëŠ” ì•ì„œ fetch joinì—ì„œ ë‹¨ì ì´ì—ˆë˜ **í˜ì´ì§• ì²˜ë¦¬ì™€ Collection Joinì´ ê°€ëŠ¥**í•˜ë‹¤. í•˜ì§€ë§Œ, Batch SizeëŠ” ìµœì í™” ë°ì´í„° ì‚¬ì´ì¦ˆë¥¼ ì•Œê¸° ì‰½ì§€ ì•Šë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤. 

### QueryBuilder

Queryë¥¼ ì‹¤í–‰í•˜ë„ë¡ ì§€ì›í•´ì£¼ëŠ” ë‹¤ì–‘í•œ í”ŒëŸ¬ê·¸ì¸ì´ ìˆëŠ”ë° ëŒ€í‘œì ìœ¼ë¡œ Mybatis, `QueryDSL`, JDBC Template ë“±ì´ ìˆë‹¤. ì´ë¥¼ ì‚¬ìš©í•˜ë©´ ë¡œì§ì— ìµœì í™”ëœ ì¿¼ë¦¬ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.

```java
// QueryDSLë¡œ êµ¬í˜„í•œ ì˜ˆì œ
return from(team).leftJoin(team.users, user).fetchJoin();
```

### ì‹¤ë¬´ì—ì„œ N+1 ë¬¸ì œë¥¼ ë°©ì§€í•˜ëŠ” ë°©ë²•

ìš°ì„  ì—°ê´€ê´€ê³„ ì„¤ì •ì€ FetchTypeì„ ëª¨ë‘ `ì§€ì—°ë¡œë”©`ìœ¼ë¡œ ì„¤ì •í•œë‹¤. ê·¸ë¦¬ê³  ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•œ ë¶€ë¶„ì—ì„œëŠ” `Fetch Join`ì„ ì‚¬ìš©í•œë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ `Batch Size`ì˜ ê°’ì€ 1000ì´í•˜ë¡œ ì„¤ì •í•œë‹¤. (ìµœì í™” ë°ì´í„° ì‚¬ì´ì¦ˆë¥¼ ì•Œê¸´ ì–´ë µë‹¤.) JPA ë§Œìœ¼ë¡œ ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ëª¨ë‘ êµ¬í˜„í•˜ê¸´ ì–´ë ¤ìš°ë¯€ë¡œ `QueryDSL`ì„ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ì€ ë°©ë²•ì´ ë  ìˆ˜ ìˆë‹¤.