---
title:  "'N + 1' ì´ë€"
last_modified_at: 2022-03-21T16:30:00
categories: 
  - JPA
tags:
  - JPA
toc: true
toc_label: "Index"
toc_sticky: true
---

## 1. N+1 ì´ë€?

ì¡°íšŒ ì‹œ 1ê°œì˜ ì¿¼ë¦¬ë¥¼ ìƒê°í•˜ê³  ì„¤ê³„ë¥¼ í–ˆìœ¼ë‚˜ ë‚˜ì˜¤ì§€ ì•Šì•„ë„ ë˜ëŠ” ì¡°íšŒì˜ ì¿¼ë¦¬ê°€ Nê°œ ë” ë°œìƒí•˜ëŠ” ë¬¸ì œ

<br>

JPAì˜ ê²½ìš° ê°ì²´ì— ëŒ€í•´ ì¡°íšŒí•œë‹¤ê³  í•´ë„ ë‹¤ì–‘í•œ ì—°ê´€ê´€ê³„ë“¤ì˜ ë§¤í•‘ì— ì˜í•´ ê´€ê³„ê°€ ë§ºì–´ì§„ ë‹¤ë¥¸ ê°ì²´ê°€ í•¨ê»˜ ì¡°íšŒë˜ëŠ” ê²½ìš°ì— N+1ì´ ë°œìƒí•¨

<br>

## 2. N+1 ì— ëŒ€í•œ ì˜ˆì œ

**User(1) : Article(N)**

User.java

```java
@Entity
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(length = 10, nullable = false)
    private String name;

    @OneToMany(mappedBy = "user")
    private List<Article> articles = new ArrayList<>();
}
```

Article.java

```java
@Entity
public class Article {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(length = 50, nullable = false)
    private String title;

    @Lob
    private String content;

    @ManyToOne
    private User user;
}
```

> ì°¸ê³ ë¡œ FetchTypeì€ Defaultë¡œ ~ToMany ì—ì„œëŠ” Lazy, ~ToOne ì—ì„œëŠ” Eagerë¡œ ì§€ì •ë¨
default ì˜µì…˜ì„ ì‚¬ìš©í•´ë„ ëª…ì‹œí•´ì£¼ëŠ” ê²ƒì´ í˜‘ì—…í•˜ëŠ” ë‹¤ë¥¸ ê°œë°œìê°€ ë³´ê¸°ì— ì¢‹ìŒ
> 

<br>

## 3. ì¦‰ì‹œë¡œë”© (fetch = fetchType.EAGER)

â†’ ì—°ê´€ë˜ìˆëŠ” ëª¨ë“  í…Œì´ë¸”ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´

```java
@OneToMany(mappedBy = "user", fetch = FetchType.EAGER)
private List<Article> articles = new ArrayList<>();
```

<br>

ì‹¤ë¬´ì—ì„œ ê°€ì¥ ì“°ì§€ë§ì•„ì•¼í• , ëª¨ë“  ë¬¸ì œì˜ ì²«ë²ˆì§¸ ì›ì¸ì´ ë˜ëŠ” ì¦‰ì‹œë¡œë”©

<br>

ì™œ ë¬¸ì œê°€ ìƒê¸¸ê¹Œ?

ì¼ë°˜ì ìœ¼ë¡œ findByIdì— ëŒ€í•œ ë©”ì†Œë“œëŠ” EntityManagerì—ì„œ PKê°’ì„ ì§€ì •í•´ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— JPAê°€ ë‚´ë¶€ì ìœ¼ë¡œ joinë¬¸ì„ ì‚¬ìš©í•´ì„œ ìµœì í™”ë¥¼ ë‹¤ìŒì²˜ëŸ¼ ì§„í–‰í•´ì¤€ë‹¤.

```java
@Test
@DisplayName("Eager typeì€ Userë¥¼ ë‹¨ì¼ ì¡°íšŒí•  ë•Œ joinë¬¸ì´ ë‚ ì•„ê°„ë‹¤.")
void userSingleFindTest() {
	System.out.println("== start ==");
	User user = userRepository.findById(1L)
		.orElseThrow(RuntimeException::new);
	System.out.println("== end ==");
}
```

```
== start == 
Hibernate: 
	select 
		user0_.id as id1_1_0_, 
		user0_.name as name2_1_0_, 
		articles1_.user_id as user_id4_0_1_, 
		articles1_.id as id1_0_1_, 
		articles1_.id as id1_0_2_, 
		articles1_.content as content2_0_2_, 
		articles1_.title as title3_0_2_, 
		articles1_.user_id as user_id4_0_2_ 
	from 
		users user0_ 
	left outer join 
		articles articles1_ 
			on user0_.id=articles1_.user_id 
	where 
		user0_.id=? 
== end == 
username1
```

inner join ë¬¸ìœ¼ë¡œ Userê°€ ì¡°íšŒë¨ê³¼ ë™ì‹œì— Articleê¹Œì§€ ì¦‰ì‹œë¡œë”© ë¨

findById ëŠ” EntityManager ì—ì„œ entityManager.find() ê°™ì´ **JPA**ê°€ ë‚´ë¶€ì ìœ¼ë¡œ joinë¬¸ì— ëŒ€í•œ ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ê¸° ë•Œë¬¸ì— ì¦‰ì‹œë¡œë”©ìœ¼ë¡œëŠ” ë¬¸ì œê°€ ì—†ì–´ë³´ì¸ë‹¤

í•˜ì§€ë§Œ, **JPQL**ì„ ì‚¬ìš©í•  ê²½ìš° ë¬¸ì œê°€ ë°œìƒí•œë‹¤. JPQLì€ SQLë¡œ ê·¸ëŒ€ë¡œ ë²ˆì—­ëœë‹¤. ë§Œì•½ Userì˜ findAll()ì„ ìš”ì²­í•˜ë©´ select u from User u; ë¼ëŠ” ì¿¼ë¦¬ê°€ ë°œìƒí•˜ê²Œ ë¨. ì—¬ê¸°ì„œ ì—°ê´€ê´€ê³„ë¡œ ì—°ê²°ëœ Articleì´ Eagerë¡œ ë˜ìˆìœ¼ë©´ select í•œ ëª¨ë“  Userì— ëŒ€í•´ Articleì´ ìˆëŠ”ì§€ë¥¼ ê²€ìƒ‰í•˜ê²Œ ëœë‹¤.

<br>

ì¦‰, ëª¨ë“  Userì— ëŒ€í•´ ê²€ìƒ‰í•˜ê³  ì‹¶ì–´ì„œ select ì¿¼ë¦¬ë¥¼ í•˜ë‚˜ ë‚ ë ¸ì§€ë§Œ**(1)**, `ì¦‰ì‹œë¡œë”©`ì´ ê±¸ë ¤ìˆì–´ ê°ê°€ì˜ Userê°€ ê°€ì§„ Articleì„ ëª¨ë‘ ê²€ìƒ‰í•œë‹¤**(N)** ë¼ëŠ” `N+1ë¬¸ì œê°€ ë°œìƒ`í•¨

<br>

```java
@Test
@DisplayName("Eager typeì€ Userë¥¼ ì „ì²´ ê²€ìƒ‰í•  ë•Œ N+1ë¬¸ì œê°€ ë°œìƒí•œë‹¤.")
void userFindTest() {
	System.out.println("== start ==");
	List<User> user = userRepository.findAll();
	System.out.println("== end ==");
}
```

```
== start ==
Hibernate: 
	/* select 
		generatedAlias0 
	from  
		User as generatedAlias0 */ select 
			user0_.id as id1_1_ 
			user0_.name as name2_1_ 
		from 
			users user0_ 

Hibernate: 
	select 
		articles0_.user_id as user_id4_0_0_, 
		articles0_.id as id1_0_0_, 
		articles0_.id as id1_0_1_, 
		articles0_.content as content2_0_1_, 
		articles0_.title as title3_0_1_, 
		articles0_.user_id as user_id4_0_1_ 
	from 
		articles articles0_ 
	where articles0_.user_id=? 

Hibernate: 
	select 
		articles0_.user_id as user_id4_0_0_, 
		articles0_.id as id1_0_0_, 
		articles0_.id as id1_0_1_, 
		articles0_.content as content2_0_1_, 
		articles0_.title as title3_0_1_, 
		articles0_.user_id as user_id4_0_1_ 
	from 
		articles articles0_ 
	where articles0_.user_id=? 

...
```

<br>

ì¦‰ì‹œë¡œë”©ì€ JPQLë¡œ ì „ë‹¬ë˜ëŠ” ê³¼ì •ì—ì„œ Eager ê°ì§€ë¡œ ì¸í•œ Nì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•˜ëŠ” ê²½ìš°ê°€ ìˆê¸° ë•Œë¬¸ì— ì‚¬ìš©í•˜ë©´ ì•ˆëœë‹¤.

<br>

## 4. ì§€ì—°ë¡œë”© (fetch = fetchType.LAZY)

â†’ í•„ìš”í•œ ì‹œì ì— ì—°ê´€ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´

```java
@OneToMany(mappedBy = "user", fetch = FetchType.LAZY)
private List<Article> articles = new ArrayList<>();
```

<br>

ì¦‰ì‹œë¡œë”©ì—ì„œ ì§€ì—°ë¡œë”©ìœ¼ë¡œ ë°”ê¿¨ìœ¼ë‹ˆ N+1ì€ ë°œìƒí•˜ì§€ ì•Šì„ê¹Œ?

â†’ No! ğŸ¤£â€™

ì§€ì—°ë¡œë”©ì€ í•´ë‹¹ entityì— ëŒ€í•´ í”„ë¡ì‹œë¡œ ê±¸ì–´ë‘ê³  ì‚¬ìš©í•  ë•Œ ì¿¼ë¦¬ë¬¸ì„ ë‚ ë¦¬ê¸° ë•Œë¬¸ì— ì²˜ìŒ findí•  ë•ŒëŠ” N+1ì´ ë°œìƒí•˜ì§€ ì•Šì§€ë§Œ ì¶”ê°€ë¡œ User ê²€ìƒ‰ í›„ Userì˜ Articleì„ ì‚¬ìš©í•´ì•¼í•œë‹¤ë©´ ì´ë¯¸ ìºì‹±ëœ Userì˜ Article í”„ë¡ì‹œì— ëŒ€í•œ ì¿¼ë¦¬ê°€ ë˜ ë°œìƒí•¨

<br>

```java
@Test
@DisplayName("Lazy typeì€ User ê²€ìƒ‰ í›„ í•„ë“œ ê²€ìƒ‰ì„ í•  ë•Œ N+1ë¬¸ì œê°€ ë°œìƒí•œë‹¤.")
void userFindTest() {
    System.out.println("== start ==");
    List<User> users = userRepository.findAll();
    System.out.println("== find all ==");
    for (User user : users) {
        System.out.println(user.articles().size());
    }
}
```

<br>

ì§€ì—°ë¡œë”© ëŒ€ìƒì¸ Articleì„ ë‚˜ì¤‘ì— ì¡°íšŒí•´ì„œ ì¿¼ë¦¬ê°€ ë‚ ì•„ê°€ëŠ” ê²ƒ ì¡°ì°¨ë„ N+1 ë¬¸ì œì˜ ì˜ˆ ì¤‘ í•˜ë‚˜

### 4.1.1 í•´ê²°ë°©ì•ˆ1. JPQL fetch join ì‚¬ìš© - ì¶”ì²œ

JPQLì— fetch join í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ì„œ join ëŒ€ìƒì„ í•¨ê»˜ ì¡°íšŒ

```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    @Query("select u from User u left join fetch u.articles")
    List<User> findAllWithFetchJoin();
}
```

<br>

ìœ„ì™€ ê°™ì´ ì‘ì„±í•˜ë©´ N+1 ë¬¸ì œ ë°œìƒí•˜ì§€ ì•ŠìŒ

<br>

```java
@Test
@DisplayName("fetch joinì„ í•˜ë©´ N+1ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.")
void fetchJoinTest() {
    System.out.println("== start ==");
    List<User> users = userRepository.findAllJPQLFetch();
    System.out.println("== find all ==");
    for (User user : users) {
        System.out.println(user.articles().size());
    }
}
```

<br>

### 4.1.2 í•´ê²°ë°©ì•ˆ2. @EntityGraph

JPQL ì—ì„œ fetch join ì„ í•˜ê²Œ ë˜ë©´ í•˜ë“œì½”ë”© í•˜ê²Œ ëœë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤.

ì´ë¥¼ ìµœì†Œí™” í•˜ê³  ì‹¶ì„ ë•Œ @EntityGraph ë¥¼ ì‚¬ìš©

```java
@EntityGraph(attributePaths = {"articles"}, type = EntityGraphType.FETCH)
@Query("select distinct u from User u left join u.articles")
List<User> findAllEntityGraph();
```