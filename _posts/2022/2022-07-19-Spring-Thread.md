---
title:  "쓰레드와 쓰레드 풀"
last_modified_at: 2022-07-19T13:45:00
categories: 
  - web
tags:
  - web
  - Spring
toc: true
toc_label: "Index"
toc_sticky: true
---

### 쓰레드

쓰레드란 프로세스의 자원을 이용해서 실제로 작업을 수행하는 것

- 애플리케이션 코드를 하나하나 순차적으로 실행하는 것
- 자바 메인 메서드를 처음 실행하면 main이라는 이름의 쓰레드가 실행
- 쓰레드가 없다면 자바 애플리케이션 실행이 불가능함
- 쓰레드는 한번에 하나의 코드 라인만 수행
- 동시 처리가 필요하면 쓰레드를 추가로 생성

<br>

요청마다 하나의 쓰레드를 생성한다고 가정하면,

동시 요청을 처리할 수 있고, 하나의 쓰레드가 지연되도 나머지 쓰레드는 정상 동작한다는 장점이 있다.

그러나, 쓰레드는 생성 비용이 매우 비싸고 요청마다 하나의 쓰레드를 생성하면 응답 속도가 늦어진다. 또한, 쓰레드는 컨텍스트 스위칭 비용이 발생한다. 컨텍스트 스위칭 비용이란 쓰레드를 전환할때 발생하는 비용을 말하는데 쓰레드가 너무 많으면 문제가 생긴다. 쓰레드 생성 시 CPU, 메모리가 사용되는데 그 임계점을 넘어서 서버가 죽을 수도 있다.

<br>

이러한 단점들은 보완한 것이 `쓰레드 풀`이다.

<br>

### 쓰레드 풀

**쓰레드 풀**에 필요한 쓰레드를 보관하고 관리하며 쓰레드 풀에 생성 가능한 쓰레드의 **최대치를 관리**한다. (톰캣의 경우 최대 200개)

쓰레드가 필요하면 쓰레드 풀에 이미 생성되어 있는 쓰레드를 꺼내서 사용하고 사용을 종료하면 쓰레드 풀에 해당 쓰레드를 반납한다. 만약, 최대 쓰레드가 모두 사용중이여서 쓰레드 풀에 쓰레드가 없다면 기다리는 요청은 거절하거나 특정 숫자만큼만 대기하도록 설정 할 수 있다.

쓰레드 풀의 **장점**은 쓰레드가 미리 생성되어 있으므로, 쓰레드를 생성하고 종료하는 비용이 절약되고 응답 시간이 빠르다. 또한, 생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다.

![스크린샷 2022-06-04 오후 7 01 17](https://user-images.githubusercontent.com/79130276/171995261-2d293258-9bda-4cfe-b119-9fdc6332eaa5.png)

<br>

**쓰레드 풀과 관련된 실무팁!**

WAS의 주요 튜닝 포인트는 `최대 쓰레드(max thread) 수`이다. max thread를 낮게 설정 시 동시 요청이 많으면 서버 리소스는 여유롭지만, 클라이언트는 금방 응답 지연된다. max thread를 높게 설정 시 동시 요청이 많으면 CPU, 메모리 리소스 임계점 초과로 서버가 다운된다.

그럼 쓰레드 풀의 적정 숫자가 뭘까? 이에 대한 **정답은 없다.** 애플리케이션 로직의 복잡도, CPU, 메모리, IO 리소스 상황에 따라 모두 다르다. 적정 숫자를 찾을 방법은 최대한 실제 서비스와 유사하게 환경을 구성 후 `성능 테스트`를 시도하는 것이다. 관련 툴로는 아파치 ab, 제이미터, **nGrinder**가 있다.

장애가 발생했다고 가정하고, 클라우드면 일단 서버부터 증설하고 이후에 튜닝을 하고 클라우드가 아니면 열심히 튜닝..해야 한다.