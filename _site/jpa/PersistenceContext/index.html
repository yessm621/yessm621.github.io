<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.23.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>영속성 컨텍스트 - yessm621.dev</title>
<meta name="description" content="영속성 컨텍스트">


  <meta name="author" content="승미">
  
  <meta property="article:author" content="승미">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="yessm621.dev">
<meta property="og:title" content="영속성 컨텍스트">
<meta property="og:url" content="http://localhost:4000/jpa/PersistenceContext/">


  <meta property="og:description" content="영속성 컨텍스트">







  <meta property="article:published_time" content="2022-08-18T00:00:00+09:00">





  

  


<link rel="canonical" href="http://localhost:4000/jpa/PersistenceContext/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "승미",
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="yessm621.dev Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- 사이트 맨위에 책 모양으로  파비콘 등록-->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/icon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/icon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/icon/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->
    <!--폰트 : "Nanum Gothic Coding", "Coming Soon"-->
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Coming+Soon&family=Nanum+Gothic+Coding&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Coming+Soon&family=Nanum+Gothic+Coding&display=swap">
     
    <!--폰트 : "Iropke Batang"-->
    <link rel="preload" as="style" href="https://cdn.jsdelivr.net/font-iropke-batang/1.2/font-iropke-batang.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/font-iropke-batang/1.2/font-iropke-batang.css">
  </head>

  <body class="layout--single <!-- 본문 늘리기!!!-->">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/setting/logo.png" alt="yessm621.dev"></a>
        
        <a class="site-title" href="/">
          yessm621.dev
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Category</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">Tag</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/setting/bio-photo.png" alt="승미" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">승미</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>공부하며 기록하는 블로그입니다.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">South Korea</span>
        </li>
      

      
        
          
            <li><a href="https://github.com/yessm621" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="mailto:yessm621@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  

  <!--전체 글 수를 세기 위한 연산. sum 변수에 전체 글 수 저장-->



<nav class="nav__list">
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">메뉴</label>
  <ul class="nav__items" id="category_tag_menu">
      
      <!--전체 글 수-->
      <li>
            📂 <span style="font-family:'Cafe24Oneprettynight';">전체 글 수</style> <span style="font-family:'Coming Soon';">65</style> <span style="font-family:'Cafe24Oneprettynight';">개</style> 
      </li>

      <li>
        <!--기본 양식
         <span class="nav__sub-title">옆에 들어갈 큰 제목</span>
            <ul> 
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        -->
    
        <!--------------------------------------분류 시작-------------------------------------------->
        <span class="nav__sub-title">Java</span><!--큰 카테고리-->
            <!--ul 태그로 같은 카테고리들 모아둔 페이지들 나열-->

            <ul>
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <li><a href="/categories/Java" class="">문법(8)</a></li>
                    
                
                    
                
                    
                
            </ul>

            <ul>
                
                    
                        <li><a href="/categories/SpringBoot" class="">SpringBoot(19)</a></li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>

            <ul>
                
                    
                
                    
                        <li><a href="/categories/Jpa" class="">JPA(23)</a></li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>

            <ul>
                
                    
                
                    
                
                    
                
                    
                        <li><a href="/categories/TestCode" class="">테스트코드(3)</a></li>
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        <!--------------------------------------분류 끝-------------------------------------------->
        
        <!--------------------------------------분류 시작-------------------------------------------->
        <!-- <span class="nav__sub-title">Python</span>
            <ul>
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>     -->
        <!--------------------------------------분류 끝-------------------------------------------->

        <!--------------------------------------분류 시작-------------------------------------------->
        <span class="nav__sub-title">Series</span>
            <ul>
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <li><a href="/categories/Series" class="">시리즈(3)</a></li>
                    
                
            </ul>    
        <!--------------------------------------분류 끝-------------------------------------------->

        <!--------------------------------------분류 시작-------------------------------------------->
        <span class="nav__sub-title">Git</span>
            <ul>
                
                    
                
                    
                
                    
                        <li><a href="/categories/Git" class="">Git(1)</a></li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>    
        <!--------------------------------------분류 끝-------------------------------------------->
        
        <!--------------------------------------분류 시작-------------------------------------------->
        <span class="nav__sub-title">CS</span>
            <ul>
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <li><a href="/categories/Http" class="">Http(5)</a></li>
                    
                
                    
                
            </ul>

            <ul>
                
                    
                
                    
                
                    
                
                    
                
                    
                        <li><a href="/categories/Auth" class="">인증/인가(3)</a></li>
                    
                
                    
                
                    
                
                    
                
            </ul>

        <!--------------------------------------분류 끝-------------------------------------------->


      </li>
 
  </ul>
</nav>

  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="영속성 컨텍스트">
    <meta itemprop="description" content="영속성 컨텍스트">
    <meta itemprop="datePublished" content="2022-08-18T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">영속성 컨텍스트
</h1>
          

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 작성일</strong> <time datetime="2022-08-18T00:00:00+09:00">August 18, 2022</time></p>

<!--작성일-->
          


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
              <ul class="toc__menu"><li><a href="#영속성-컨텍스트">영속성 컨텍스트</a></li><li><a href="#엔티티의-생명주기">엔티티의 생명주기</a><ul><li><a href="#비영속">비영속</a></li><li><a href="#영속">영속</a></li><li><a href="#준영속">준영속</a></li><li><a href="#삭제">삭제</a></li></ul></li><li><a href="#영속성-컨텍스트-특징">영속성 컨텍스트 특징</a><ul><li><a href="#엔티티-조회">엔티티 조회</a></li><li><a href="#엔티티-저장">엔티티 저장</a></li><li><a href="#엔티티-수정">엔티티 수정</a></li><li><a href="#엔티티-삭제">엔티티 삭제</a></li></ul></li></ul>

            </nav>
          </aside>
        
        <h2 id="영속성-컨텍스트">영속성 컨텍스트</h2>

<p>JPA를 이해하는데 가장 중요한 용어가 영속성 컨텍스트이다.</p>

<p><em><code class="language-plaintext highlighter-rouge">영속성 컨텍스트</code>란 엔티티를 영구 저장하는 환경이라는 뜻이다.</em> 엔티티 매니저로 엔티티를 저장하거나 조회하면 엔티티 매니저는 영속성 컨텍스트에 엔티티를 보관하고 관리한다. 영속성 컨텍스트는 애플리케이션과 DB 사이에서 객체를 보관하는 가상의 DB 같은 역할을 한다.</p>

<p><strong>엔티티를 영속성 컨텍스트에 저장</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">entityManager</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
</code></pre></div></div>

<p>영속성 컨텍스트는 눈에 보이는 개념이 아니고 <strong>논리적인 개념</strong>이다. 영속성 컨텍스트는 엔티티 매니저를 생성할 때 하나 만들어진다. 엔티티 매니저를 통해서 영속성 컨텍스트에 접근하고 관리할 수 있다.</p>

<h2 id="엔티티의-생명주기">엔티티의 생명주기</h2>

<p>엔티티의 4가지 상태는 다음과 같다.</p>

<ol>
  <li>비영속(new, transient): 영속성 컨텍스트와 전혀 관계가 없는 상태</li>
  <li>영속(managed): 영속성 컨텍스트에 저장된 상태</li>
  <li>준영속(detached): 영속성 컨텍스트에 저장되었다가 분리된 상태</li>
  <li>삭제(delete): 삭제된 상태</li>
</ol>

<p><img src="https://user-images.githubusercontent.com/79130276/223943030-bb3614a9-850a-4f4f-bc0b-4147172b19b6.png" alt="1" /></p>

<h3 id="비영속">비영속</h3>

<p><em>엔티티 객체를 생성했고 <strong>순수한 객체 상태</strong>이며 아직 저장하지 않은 상태이다.</em> 영속성 컨텍스트나 DB와는 전혀 관련이 없다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 객체를 생성한 상태(비영속)</span>
<span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">();</span> 
<span class="n">member</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"member1"</span><span class="o">);</span> 
<span class="n">member</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"회원1"</span><span class="o">);</span>
</code></pre></div></div>

<h3 id="영속">영속</h3>

<p><em>엔티티 매니저를 통해 엔티티를 영속성 컨텍스트에 저장한 상태이다.</em> 영속성 컨텍스트에 의해 엔티티가 관리되는 상태를 영속 상태라 한다.</p>

<p>영속 상태에서는 바로 DB에 저장되지 않는다. <strong>트랜잭션의 commit 시점</strong>에 영속성 컨텍스트에 있는 정보들이 DB에 저장된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 객체를 생성한 상태(비영속) </span>
<span class="nc">Member</span> <span class="n">member</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Member</span><span class="o">();</span> 
<span class="n">member</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"member1"</span><span class="o">);</span> 
<span class="n">member</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"회원1"</span><span class="o">);</span>

<span class="nc">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">emf</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span> <span class="c1">// 엔티티 매니저 생성</span>
<span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">begin</span><span class="o">();</span> <span class="c1">// 엔티티 트랜잭션 시작</span>

<span class="c1">// 객체를 저장한 상태(영속)</span>
<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
</code></pre></div></div>

<h3 id="준영속">준영속</h3>

<p>영속성 컨텍스트가 관리하던 영속 상태의 엔티티가 영속성 컨텍스트에서 분리된 상태이다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//회원 엔티티를 영속성 컨텍스트에서 분리, 준영속 상태 </span>
<span class="n">em</span><span class="o">.</span><span class="na">detach</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
</code></pre></div></div>

<h3 id="삭제">삭제</h3>

<p>엔티티를 영속성 컨텍스트와 DB에서 삭제한 상태이다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//객체를 삭제한 상태(삭제) </span>
<span class="n">em</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
</code></pre></div></div>

<h2 id="영속성-컨텍스트-특징">영속성 컨텍스트 특징</h2>

<p>영속성 컨텍스트의 특징은 다음 3가지와 같다.</p>

<ol>
  <li>영속성 컨텍스트와 <strong>식별자 값</strong>
    <ul>
      <li>영속성 컨텍스트는 엔티티를 식별자 값으로 구분한다. 따라서, 영속 상태는 식별자 값이 반드시 있어야 한다. 식별자 값이 없으면 예외가 발생한다.
        <ul>
          <li>식별자 값: @Id로 테이블의 기본 키와 매핑한 값</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>영속성 컨텍스트와 <strong>데이터베이스 저장</strong>
    <ul>
      <li>영속성 컨텍스트에 저장된 엔티티가 DB에 저장되는 시점은 <strong>트랜잭션을 커밋</strong>하는 시점이다.</li>
      <li>트랜잭션을 커밋하는 순간 영속성 컨텍스트에 새로 저장된 엔티티를 DB에 반영한다. 이를 플러시(flush())라고 한다.</li>
    </ul>
  </li>
  <li>영속성 컨텍스트가 엔티티를 관리할 때 <strong>장점</strong>
    <ul>
      <li>1차 캐시</li>
      <li>동일성 보장</li>
      <li>트랜잭션을 지원하는 쓰기 지연</li>
      <li>변경 감지</li>
      <li>지연 로딩</li>
    </ul>
  </li>
</ol>

<p>영속성 컨텍스트가 필요한 이유와 이점을 자세히 설명하기 위해 엔티티를 CRUD하며 알아보겠다.</p>

<h3 id="엔티티-조회">엔티티 조회</h3>

<p><em>영속성 컨텍스트는 내부에 캐시를 가지고 있는데 이를 1차 캐시라 한다.</em> 모든 영속 상태의 엔티티는 1차 캐시에 저장된다. 쉽게 이야기하면 영속성 컨텍스트 내부에 Map이 하나 있는데 키는 @Id로 매핑한 식별자고 값은 엔티티 인스턴스다.</p>

<p>1차 캐시의 키는 식별자(@Id) 값이다. 식별자 값은 데이터베이스 기본 키와 매핑되어 있다. 따라서, 영속성 컨텍스트에 데이터를 저장하고 조회하는 모든 기준은 데이터베이스 기본 키 값이다.</p>

<p>em.find()를 호출하면 메모리에 있는 1차 캐시에서 엔티티를 찾는다. 만약 1차 캐시에 찾는 엔티티가 없으면 데이터베이스에서 조회한다.</p>

<p><strong>1차 캐시에서 조회</strong></p>

<p>엔티티 인스턴스가 1차 캐시에 있으면 이 엔티티들을 조회하면 메모리에 있는 1차 캐시에서 바로 불러온다. 따라서, 성능상 이점을 누릴 수 있다.</p>

<p><img src="https://user-images.githubusercontent.com/79130276/223942577-0b05a7cf-ba3a-4d34-ac28-2f9875383519.png" alt="1" /></p>

<p><strong>데이터베이스에서 조회</strong></p>

<ol>
  <li>em.find(Member.class, “member2”)를 실행</li>
  <li>member2가 1차 캐시에 없으면 데이터베이스에서 조회</li>
  <li>조회한 데이터로 member2 엔티티를 생성해서 1차 캐시에 저장 (영속 상태)</li>
  <li>조회한 엔티티를 반환</li>
</ol>

<p><img src="https://user-images.githubusercontent.com/79130276/223942579-6d127db9-0534-41b1-8f01-9dd75a0f0f76.png" alt="2" /></p>

<p><strong>영속 엔티티의 동일성 보장</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Member</span> <span class="n">a</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"member1"</span><span class="o">);</span>
<span class="nc">Member</span> <span class="n">b</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"member1"</span><span class="o">);</span>
</code></pre></div></div>

<p>여기서 ‘a == b’는 참이다. 영속성 컨텍스트는 1차 캐시에 있는 같은 엔티티 인스턴스를 반환한다. <strong>영속성 컨텍스트는 성능상 이점과 엔티티의 동일성을 보장</strong>한다.</p>

<blockquote>
  <p><strong>참고</strong> 동일성과 동등성
동일성(identity)은 실제 인스턴스가 같다. 따라서, 참조 값을 비교하는 == 비교의 값이 같다.
동등성(equality)는 실제 인스턴스는 다를 수 있지만 인스턴스가 가지고 있는 값이 같다. 자바에서 동등성 비교는 equals() 메소드를 구현해야 한다.</p>

</blockquote>

<h3 id="엔티티-저장">엔티티 저장</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">emf</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
<span class="nc">EntityTransaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">();</span>

<span class="n">tx</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span> <span class="c1">// 트랜잭션 시작</span>

<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">memberA</span><span class="o">);</span>
<span class="n">em</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">memberB</span><span class="o">);</span>
<span class="c1">// 여기까지는 INSERT 쿼리를 데이터베이스에 보내지 않는다.</span>

<span class="c1">// 커밋하는 순간 데이터베이스에 INSERT 쿼리를 전송한다.</span>
<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span> <span class="c1">// 트랜잭션 커밋</span>
</code></pre></div></div>

<p>엔티티 매니저는 트랜잭션을 커밋하기 전까지 데이터베이스에 엔티티를 저장하지 않고 <strong>내부 쿼리 저장소</strong>에 INSERT SQL을 모아둔다. 그리고 트랜잭션을 커밋할 때 모아둔 쿼리를 데이터베이스에 보내는데 이를 트랜잭션을 지원하는 쓰기 지연(transactional write-behind)이라 한다.</p>

<p>memberA에 대해 영속화할 때 1차 캐시에 회원 엔티티를 저장하면서 동시에 회원 엔티티 정보로 등록 쿼리를 만든다. 그리고 만들어진 등록 쿼리를 쓰기 지연 SQL 저장소에 보관한다.</p>

<p><img src="https://user-images.githubusercontent.com/79130276/223942584-7361a124-4906-42da-9d3d-f7d695b9747f.png" alt="3" /></p>

<p>이제 memberB를 영속화한다. memberA와 마찬가지로 회원 엔티티 정보로 등록 쿼리를 생성해서 쓰기 지연 SQL 저장소에 보관한다. 현재 쓰기 지연 SQL 저장소에는 등록 쿼리가 2건 저장되었다.</p>

<p><img src="https://user-images.githubusercontent.com/79130276/223942587-744ea9d6-7328-43c7-ba55-f8eb90afce7b.png" alt="4" /></p>

<p>이제 마지막으로 트랜잭션을 커밋했다. <strong>트랜잭션을 커밋</strong>하면 엔티티 매니저는 영속성 컨텍스트를 <code class="language-plaintext highlighter-rouge">플러시</code>한다. 플러시는 영속성 컨텍스트의 변경 내용을 데이터베이스에 동기화하는 작업인데 이때 등록, 수정, 삭제한 엔티티를 데이터베이스에 반영한다. 즉, <strong>쓰기 지연 SQL 저장소에 모인 쿼리를 데이터베이스에 보내 변경 내용을 데이터베이스에 적용하고 영속성 컨텍스트와 동기화한 후에 실제 데이터베이스 트랜잭션을 커밋한다.</strong></p>

<p><img src="https://user-images.githubusercontent.com/79130276/223942589-2c91ffaf-25da-436f-a699-d99b3495892b.png" alt="5" /></p>

<p><strong>트랜잭션을 지원하는 쓰기 지연이 가능한 이유</strong></p>

<p><code class="language-plaintext highlighter-rouge">Case1</code> 데이터를 저장하는 즉시 등록 쿼리를 데이터베이스에 보낸다. 그리고 마지막에 트랜잭션을 커밋한다.</p>

<p><code class="language-plaintext highlighter-rouge">Case2</code> 데이터를 저장하면 등록 쿼리를 메모리에 모아두고 트랜잭션을 커밋할 때 모아둔 등록 쿼리를 데이터베이스에 보낸 후에 커밋한다.</p>

<p>두가지 Case 모두 트랜잭션 범위 안에서 실행되므로 결과는 같다. <strong>트랜잭션을 커밋하기 직전에만 데이터베이스에 SQL을 전달하면 된다.</strong> 이것이 트랜잭션을 지원하는 쓰기 지연이 가능한 이유다.</p>

<h3 id="엔티티-수정">엔티티 수정</h3>

<p><strong>SQL 수정 쿼리의 문제점</strong></p>

<p>SQL을 사용하면 수정 쿼리를 직접 작성해야 한다. 문제점은 수정 쿼리가 많아지면 비스니스 로직을 분석하기 위해 SQL을 확인해야 하므로 직/간접적으로 비즈니스 로직이 SQL에 의존하게 된다.</p>

<p>⭐ <strong>변경 감지</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">emf</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
<span class="nc">EntityTransaction</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">();</span>

<span class="n">tx</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span> <span class="c1">// 트랜잭션 시작</span>

<span class="nc">Member</span> <span class="n">memberA</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"memberA"</span><span class="o">);</span> <span class="c1">// 영속 엔티티 조회</span>

<span class="c1">// 영속 엔티티 데이터 수정</span>
<span class="n">memberA</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"hi"</span><span class="o">);</span>
<span class="n">memberA</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>

<span class="c1">// update를 하기 위해 이 코드가 있어야 하지 않을까?</span>
<span class="c1">// em.update(member);</span>

<span class="n">tx</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span> <span class="c1">// 트랜잭션 커밋</span>
</code></pre></div></div>

<p>JPA로 엔티티를 수정할 때 em.update()를 실행해야 할 것 같지만 이런 메소드는 없다. JPA에서는 엔티티의 데이터만 변경해도 데이터베이스에 반영된다. 그 이유는 엔티티의 변경사항을 데이터베이스에서 자동으로 반영하는 <code class="language-plaintext highlighter-rouge">변경 감지(Dirty Checking)</code> 기능을 사용하기 때문이다.</p>

<p>JPA는 엔티티를 영속성 컨텍스트에 보관할 때 최초 상태를 복사해서 저장해두는데 이를 스냅샷이라 한다. 그리고 플러시 시점에 스냅샷과 엔티티를 비교해서 변경된 엔티티를 찾는다. 아래 그림을 순서대로 분석해보자.</p>

<p><img src="https://user-images.githubusercontent.com/79130276/223942591-b8dc3a59-4c78-4bda-908c-c7cd54617e4e.png" alt="6" /></p>

<ol>
  <li>트랜잭션 커밋 시 엔티티 매니저 내부에서 먼저 플러시가 호출된다.</li>
  <li><strong>엔티티와 스냅샷을 비교</strong>해서 변경된 엔티티를 찾는다.</li>
  <li><strong>변경된 엔티티가 있으면 수정 쿼리를 생성해서 쓰기 지연 SQL 저장소에 보낸다.</strong></li>
  <li>쓰기 지연 저장소의 SQL을 데이터베이스에 보낸다.</li>
  <li>데이터베이스 트랜잭션을 커밋한다.</li>
</ol>

<p><strong>변경 감지는 영속성 컨텍스트가 관리하는 영속 상태의 엔티티에만 적용된다.</strong></p>

<p>JPA의 기본 전략은 엔티티의 모든 필드를 업데이트 한다. 하지만, <code class="language-plaintext highlighter-rouge">변경 감지</code>로 인해 실행된 UPDATE SQL은 <strong>변경된 필드만 업데이트하고 변경되지 않은 필드에 대해서는 아무런 처리를 하지 않는다.</strong></p>

<h3 id="엔티티-삭제">엔티티 삭제</h3>

<p>엔티티를 삭제하기 위해선 먼저 삭제 대상 엔티티를 조회해야 한다. 엔티티 등록과 비슷하게 바로 삭제되는 것이 아니라 삭제 쿼리를 쓰기 지연 SQL 저장소에 등록했다가 트랜잭션 커밋 시점에 플러시를 호출하면서 실제 데이터베이스에 삭제 쿼리를 전달한다. 그리고 삭제된 엔티티는 영속성 컨텍스트에서 제거된다.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#jpa" class="page__taxonomy-item" rel="tag">Jpa</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#jpa" class="page__taxonomy-item" rel="tag">Jpa</a>
    
    </span>
  </p>



        <!--

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 작성일</strong> <time datetime="2022-08-18T00:00:00+09:00">August 18, 2022</time></p>

작성일-->
      </footer>

      

      <!-- 기존 코드

  <nav class="pagination">
    
      <a href="/jpa/ORMJPAHibernate/" class="pagination--pager" title="ORM과 JPA, Hibernate
">이전</a>
    
    
      <a href="/jpa/EntityManger/" class="pagination--pager" title="엔티티 매니저 팩토리와 엔티티 매니저
">다음</a>
    
  </nav>

-->


<!--같은 카테고리내에서 다음으로 이동하는 것.-->



  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
  	
  	
  	
  	
  	


  <nav class="pagination_prev_next" style="padding-top: 5px; padding-bottom: 5px;">
    
      <a href="/jpa/ORMJPAHibernate/" class="pagination_prev_next--pager"><span class="prev_next">이전 글  &nbsp</span>ORM과 JPA, Hibernate</a>
    
    
      <a href="/jpa/EntityManger/" class="pagination_prev_next--pager"><span class="prev_next">다음 글  &nbsp  </span>엔티티 매니저 팩토리와 엔티티 매니저</a>
    
  </nav>


    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>팔로우:</strong></li>
    

    
      
        
          <li><a href="https://github.com/yessm621" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 승미 <a href="https://jekyllrb.com" rel="nofollow"></a>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>










  </body>
</html>
